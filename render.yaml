services:
  - type: web
    name: health-metric-app
    env: python
    buildCommand: |
      echo "ğŸŸ¢ Starting build..."
      pip install -r requirements.txt

      echo "ğŸ“¦ Collecting static files..."
      python manage.py collectstatic --noinput

      echo "ğŸ›  Running migrations..."
      python manage.py migrate --noinput

      echo "âœ… Build and migration completed."
    startCommand: gunicorn BMI_calculator.wsgi:application
    envVars:
      - key: DEBUG
        value: "False"
      - key: SECRET_KEY
        value: 4om%rc413!hz@6xjcsykpzu88%1p696q@)-kl3^5tgl8hosu24
      - key: DATABASE_URL
        value: postgresql://healthuser:R73zfkFXJ4TQ5y1Oe40l28O08iQwm9WY@dpg-d1qmb27fte5s73dh7820-a/healthmetric_db
      - key: ALLOWED_HOSTS
        value: health-metric-app.onrender.com

jobs:
  - type: cron
    name: ensure-migrations
    schedule: "@on_deploy"  # This runs on every deploy
    env: python
    command: |
      echo "ğŸ” Ensuring migrations are applied..."
      python manage.py migrate
      echo "âœ… Migrations done."
    envVars:
      - fromService: health-metric-app
